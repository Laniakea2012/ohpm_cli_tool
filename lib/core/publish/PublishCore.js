"use strict";var e=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,r,s)}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),t=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(i){if(i&&i.__esModule)return i;var r={};if(null!=i)for(var s in i)"default"!==s&&Object.prototype.hasOwnProperty.call(i,s)&&e(r,i,s);return t(r,i),r},r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function n(e){try{l(r.next(e))}catch(e){a(e)}}function o(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((r=r.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PublishCore=void 0;const a=require("./common"),n=require("./util/validPkgPath"),o=require("../scripts/ScriptRunner"),l=require("../dependency/util"),u=s(require("path")),c=i(require("tar")),d=require("../../util"),h=require("../missing-dep-detect/DepStatementsMissingDetector"),g=require("../../config"),p=s(require("../../log")),v=require("../../common/message"),f=require("../../common/Constants"),y=require("./util/validatePkgSize"),P=require("./util/validateHmPackage"),b=require("../validator"),m=require("./util/validateTag"),k=require("./util/getPublishPkgContent"),C=require("./util/getAndValidPublishRegistry"),M=require("./util/validAndFixAuthor"),E=require("../../util/FsUtil"),S=require("../registry/publication/impl/OhpmPublication"),D=require("../registry/publication/utils/getAuthorization"),z=require("./util/validateCompability"),_=require("./util/interceptDebugPackage"),H=require("../registry/publication/impl/authorization/SshAuthorization"),q=require("../audit"),w=require("../registry/types");exports.PublishCore=class{constructor(){this.validator=b.PackageValidatorImpl.getInstance()}prepublish(e){return r(this,void 0,void 0,(function*(){let t,i=!1;try{(0,n.validPkgPath)(e),i=(0,a.isTgzFile)(e),t=yield this.getManifest(e,i),t=yield(0,M.validAndFixAuthor)(t),yield this.validPublishPkg(i,e,t),(0,_.interceptDebugPackage)(!1,t),(0,d.output)(`prepublish ${t.name} ${t.version} succeed.`)}finally{yield this.clearCache(i,t)}}))}publish(e,t){return r(this,void 0,void 0,(function*(){let i,r=!1;try{(0,n.validPkgPath)(e),(0,m.validateTag)(t.tag),r=(0,a.isTgzFile)(e),i=yield this.getManifest(e,r),i=yield(0,M.validAndFixAuthor)(i);const s=(0,C.getAndValidPublishRegistry)(i,t);yield this.validPublishPkg(r,e,i),o.ScriptRunner.runHook(o.ScriptConstants.prePublish,void 0,i),yield this.publishPkg(r,e,i,s),o.ScriptRunner.runHook(o.ScriptConstants.postPublish,void 0,i)}finally{yield this.clearCache(r,i)}}))}validPublishPkg(e,t,i){return r(this,void 0,void 0,(function*(){if(yield(0,z.validateCompability)(t,i),yield this.validator.validate(i),yield this.missingDepStatementCheck(i),e){this.validPackageType(i.packageType);const e=u.default.resolve(i.cache,i.hspPkg.interfaceHar),t=yield this.validHarContent(e,i),r=u.default.resolve(i.cache,i.hspPkg.hsp),s=yield this.validHspContent(r);i.size=t.pkgSize+s.pkgSize,i.fileNum=t.pkgFileNum+s.pkgFileNum}else{const e=yield this.validHarContent(t,i);i.size=e.pkgSize,i.fileNum=e.pkgFileNum}}))}validHarContent(e,t){return r(this,void 0,void 0,(function*(){const i=yield(0,k.getPublishPkgContent)(e,t);return(0,y.validatePkgSize)(i.content),(0,P.validateHmPackage)(t,t.harCache),{pkgSize:i.content.size,pkgFileNum:i.content.entryCount}}))}validHspContent(e){return r(this,void 0,void 0,(function*(){const t=yield(0,k.getPublishPkgContent)(e,null);if(t.content.size<=0)throw new Error((0,v.format)(v.Messages.Publish.HspFileIsEmpty,{path:e}));return(0,y.validatePkgSize)(t.content),{pkgSize:t.content.size,pkgFileNum:t.content.entryCount}}))}getManifest(e,t){return r(this,void 0,void 0,(function*(){const i=process.cwd();return t?this.getTgzManifest(e,i):this.getHarManifest(e,i)}))}getMetaData(e,t,i,s){return r(this,void 0,void 0,(function*(){const r=s?yield this.buildTgzMeta(e,t,i):yield this.buildHarMeta(e,t,i);return r.pkg=e,r}))}getTgzManifest(e,t){return r(this,void 0,void 0,(function*(){const i=yield(0,l.hspDetect)(e);if(!i)throw new Error((0,v.format)(v.Messages.Publish.InvalidTgzFile,{path:e}));const r={};r.hspPkg=i;const s=(0,a.genCachePath)();r.cache=s,r.harCache=u.default.resolve(s,i.interfaceHar.split(".")[0]),r.hspCache=u.default.resolve(s,i.hsp.split(".")[0]),c.extract({file:e,cwd:s,strip:0,sync:!0},[i.interfaceHar,i.hsp]),d.FsBlockingUtil.createDirIfNotExists(r.harCache),d.FsBlockingUtil.createDirIfNotExists(r.hspCache);const n=yield this.getHarManifest(u.default.resolve(s,i.interfaceHar),t,r.harCache);return Object.assign(Object.assign({},r),n)}))}getHarManifest(e,t,i){return r(this,void 0,void 0,(function*(){let r=yield(0,a.getManifest)(e,t,i);return r=yield(0,a.patchManifest)(r),r}))}missingDepStatementCheck(e){return r(this,void 0,void 0,(function*(){const t=e.harCache,i=new h.DepStatementsMissingDetector,r=[];try{r.push(...yield i.detectMissingDeps(t))}catch(e){if(g.config.get(g.types.ENSURE_DEPENDENCY_INCLUDE))throw e}if(r.length>0){if(g.config.get(g.types.ENSURE_DEPENDENCY_INCLUDE))throw i.missingMessages.forEach((e=>p.default.error("",e))),new Error(v.Messages.Publish.DepStatementsMissing);i.missingMessages.forEach((e=>p.default.warn("",e)))}}))}publishPkg(e,t,i,s){return r(this,void 0,void 0,(function*(){const r=yield this.getMetaData(t,i,s,e);this.clearUnUsedFieldInMetadata(e,i,r);const a=yield(0,D.getAuthorization)(s.registry);(0,_.interceptDebugPackage)(a instanceof H.SshAuthorization,i),this.genPublishAuditData(i,a);const n=yield new S.OhpmPublication(a).publishPackage(i.size,r,s.registry);(0,d.output)(`+${i.name} ${i.version} `),n.additionalMsg&&(0,d.output)(n.additionalMsg)}))}clearUnUsedFieldInMetadata(e,t,i){e?(i.versions[t.version].hspPkg=void 0,i.versions[t.version].cache=void 0,i.versions[t.version].harCache=void 0,i.versions[t.version].hspCache=void 0):i.versions[t.version].harCache=void 0}buildTgzMeta(e,t,i){return r(this,void 0,void 0,(function*(){this.validPackageType(t.packageType);const e=[],r=[],s=u.default.resolve(t.cache,t.hspPkg.interfaceHar);r.push(this.buildHarMeta(s,t,i).then((t=>{e.push(t)})));const a=u.default.resolve(t.cache,t.hspPkg.hsp);return r.push(this.buildHspMeta(a,t,i).then((t=>{e.push(t)}))),yield Promise.all(r),this.mergeResolves(t.name,t.version,e)}))}mergeResolves(e,t,i){return r(this,void 0,void 0,(function*(){let r=-1,s=-1;if(i.forEach(((e,t)=>{e.name?r=t:s=t})),-1===r||-1===s)throw new Error((0,v.format)(v.Messages.Publish.BuildTgzMetadataFailed,{name:e,version:t}));const a=i[r];a.versions[t].dist.integrity_hsp=i[s].integrity_hsp,a.hspType=i[s].hspType;const n=`${e}-${t}${f.Constants.HSP_SUFFIX}`;return a._attachments[n]=i[s]._attachments[n],a}))}validPackageType(e){if(!e)throw new Error(v.Messages.Validator.PackageTypeEmptyError);if(e!==f.Constants.HSPPackageType)throw new Error(v.Messages.Validator.PackageTypeInvalidError)}buildHarMeta(e,t,i){return r(this,void 0,void 0,(function*(){const r=yield(0,k.getPublishPkgContent)(e,t);return yield(0,a.logHar)(r.content,i),(0,a.buildHarMetaData)(i.registry,t,r.buff)}))}buildHspMeta(e,t,i){return r(this,void 0,void 0,(function*(){const r=yield(0,k.getPublishPkgContent)(e,null);return yield(0,a.logHsp)(r.content),(0,a.buildHspMetaData)(i.registry,t,r.buff)}))}clearCache(e,t){return r(this,void 0,void 0,(function*(){p.default.debug("","start clear cache."),t&&(e?yield E.FsUtil.remove(t.cache):yield E.FsUtil.remove(t.harCache),p.default.debug("","clear cache succeed."))}))}genPublishAuditData(e,t){const i={packageSize:e.size,fileNum:e.fileNum,authMode:t instanceof H.SshAuthorization?w.AuthType.sshKey:w.AuthType.accessToken,useStrictSsl:g.config.get(g.types.STRICT_SSL),useEnsureDepInclude:g.config.get(g.types.ENSURE_DEPENDENCY_INCLUDE)};q.auditParamsManager.add(i)}};