"use strict";var t=this&&this.__createBinding||(Object.create?function(t,e,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(e,n);s&&!("get"in s?!e.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,i,s)}:function(t,e,n,i){void 0===i&&(i=n),t[i]=e[n]}),e=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),n=this&&this.__importStar||function(n){if(n&&n.__esModule)return n;var i={};if(null!=n)for(var s in n)"default"!==s&&Object.prototype.hasOwnProperty.call(n,s)&&t(i,n,s);return e(i,n),i},i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function r(t){try{u(i.next(t))}catch(t){a(t)}}function o(t){try{u(i.throw(t))}catch(t){a(t)}}function u(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,o)}u((i=i.apply(t,e||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getContents=exports.logHsp=exports.logHar=exports.buildHspMetaData=exports.buildHarMetaData=exports.patchManifest=exports.getManifest=exports.genCachePath=exports.isTgzFile=void 0;const s=n(require("path")),a=require("../../util"),r=require("../../tools/ssri/Ssri"),o=n(require("tar")),u=require("../../tools/columnify/Columnify"),c=require("../../common/Constants"),l=require("uuid"),p=require("../cache"),f=require("../../config"),g=require("../../util/FsUtil");function h(){const t=`${f.config.getString(f.types.CACHE)}/${p.CacheConstants.HarBallDir}/${(0,l.v4)().replace(/-/g,"")}/`;return a.FsBlockingUtil.createDirIfNotExists(t),t}exports.isTgzFile=function(t){return!!t&&t.endsWith(c.Constants.TGZ_SUFFIX)},exports.genCachePath=h,exports.getManifest=function(t,e,n){return i(this,void 0,void 0,(function*(){let i;const r=n&&"{}"!==n?n:h();let u;void 0===t?i=s.join(e,c.Constants.MyPackageJson):a.FsBlockingUtil.statSync(t).isDirectory()?i=s.join(t,c.Constants.MyPackageJson):(yield o.extract({file:t,cwd:r,strip:1}),i=s.join(r,c.Constants.MyPackageJson));try{u=a.FsBlockingUtil.readJSON5Sync(i),u.harCache=r}catch(t){if(t&&t.message){const e=g.FsUtil.slash(r);t.message=t.message.replace(e,"package/")}throw t}return u}))},exports.patchManifest=function(t){return i(this,void 0,void 0,(function*(){return t._nodeVersion=process.versions.node,t[`_${c.Constants.PM}Version`]=c.Constants.PmVersion,t}))},exports.buildHarMetaData=function(t,e,n){return i(this,void 0,void 0,(function*(){const i=Object.assign({},e),s={_id:i.name,name:i.name,packageType:i.packageType,description:i.description,"dist-tags":{},versions:{}};s.versions[i.version]=i;const a=i.tag||"latest";s["dist-tags"][a]=i.version;const o=`${i.name}-${i.version}${c.Constants.HAR_SUFFIX}`,u=`${i.name}/-/${o}`,l=r.ssri.fromData(n);return i._id=`${i.name}@${i.version}`,i.dist=Object.assign({},i.dist),i.dist.integrity=l.getIntegrity(),i.dist.tarball=new URL(u,t).href.replace(/^http:\/\//,"https://"),s._attachments={},s._attachments[o]={content_type:"application/octet-stream",data:n.toString("base64"),length:n.length},s}))},exports.buildHspMetaData=function(t,e,n){return i(this,void 0,void 0,(function*(){const t={},i=`${e.name}-${e.version}${c.Constants.HSP_SUFFIX}`,s=r.ssri.fromData(n);return t.integrity_hsp=s.getIntegrity(),t.hspType=c.HspType.BUNDLE_APP,t._attachments={},t._attachments[i]={content_type:"application/octet-stream",data:n.toString("base64"),length:n.length},t}))},exports.logHar=function(t,e){return i(this,void 0,void 0,(function*(){const n=new RegExp(`^${c.Constants.MyModules}/`);(0,a.output)(`registry:${e.registry}`),(0,a.output)(""),(0,a.output)(`package:${t.name}@${t.version}\n`),(0,a.output)("=== Harball Contents ==="),t.files.length&&(0,a.output)(u.columnify.format(t.files.map((t=>{const e=d(t.size,!1);return/^node_modules\//.test(t.path)||n.test(t.path)?"":{key:`${e}`,value:t.path}})))),(0,a.output)("=== Harball Details ==="),(0,a.output)(u.columnify.format([{key:"name:",value:t.name},{key:"version:",value:t.version},t.filename&&{key:"filename:",value:t.filename},{key:"package size:",value:d(t.size)},{key:"unpacked size:",value:d(t.unpackedSize)},{key:"shasum:",value:t.shasum},{key:"integrity:",value:t.integrity.toString()},{key:"total files:",value:t.entryCount}])),(0,a.output)("")}))},exports.logHsp=function(t){return i(this,void 0,void 0,(function*(){(0,a.output)("=== Hspball Details ==="),(0,a.output)(u.columnify.format([{key:"shasum:",value:t.shasum},{key:"integrity_hsp:",value:t.integrity.toString()}])),(0,a.output)("")}))},exports.getContents=function(t,e){return i(this,void 0,void 0,(function*(){const n=[];let i=0,s=0;o.t({onentry(t){"Directory"!==t.type&&(i++,s+=void 0===t.size?0:t.size,n.push({path:t.path.replace(/^package\//,""),size:void 0===t.size?0:t.size,mode:t.mode}))}}).end(e);const a=yield r.ssri.fromData(e,{algorithms:["sha1","sha512"]}),u=t=>{const e=t.charAt(0);return e===e.toUpperCase()},l=n.filter((t=>u(t.path))),p=n.filter((t=>!u(t.path)));return function(t){const e=t.integrity.get("sha1")[0].getDigest();return t.manifest?{id:t.manifest._id||`${t.manifest.name}@${t.manifest.version}`,name:t.manifest.name,version:t.manifest.version,size:t.tarball.length,unpackedSize:t.totalEntrySize,shasum:e,integrity:r.ssri.parse(t.integrity.getIntegrity()),filename:`${t.manifest.name}-${t.manifest.version}${c.Constants.HAR_SUFFIX}`,files:t.uppers.concat(t.others),entryCount:t.totalEntries,packageType:t.manifest.packageType}:{size:t.tarball.length,unpackedSize:t.totalEntrySize,shasum:e,integrity:r.ssri.parse(t.integrity.getIntegrity()),files:t.uppers.concat(t.others),entryCount:t.totalEntries}}({totalEntries:i,totalEntrySize:s,integrity:a,manifest:t,tarball:e,uppers:l,others:p})}))};const d=(t,e=!0)=>{let n="";return e&&(n=" "),t<1024?`${t}${n}B`:t<1048576?`${(t/1024).toFixed(1)}${n}kB`:t<1073741824?`${(t/1048576).toFixed(1)}${n}MB`:`${(t/1073741824).toFixed(1)}${n}GB`};