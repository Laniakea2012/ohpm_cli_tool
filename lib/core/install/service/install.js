"use strict";var e=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(a,r){function i(e){try{l(o.next(e))}catch(e){r(e)}}function s(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,s)}l((o=o.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.install=void 0;const t=require("../../../util"),n=require("./handleCliInput"),o=require("./installModules"),a=require("../common/updatePkgJson"),r=require("../../locker"),i=require("../../dependency/util/deleteEmptyOhModulesDir"),s=require("./updateCommandLineInputDependencies"),l=require("./createRootNodesForInstallation"),c=require("./getModuleRootDirs"),u=require("../../install-targets/TargetManager"),d=require("../common/savePackageJsonOfResolveConflict");exports.install=function(g,f,p){return e(this,void 0,void 0,(function*(){const e=(new Date).getTime(),v=(0,c.getModuleRootDirs)(g,p),m=r.PackageLockerManager.getInstance();try{m.syncLoadLockers(v);const e=yield(0,l.createRootNodesForInstallation)(v,f,p),t=yield(0,o.installModules)(e);p.saveDynamic||p.saveDev?p.saveProd=!1:p.saveProd=p.save;for(const e of t)if(e.moduleRootDir!==g||u.TargetManager.getInstance().isTargetMod()||((0,s.updateCommandLineInputDependencies)(e,n.cliInputNames),yield(0,a.updatePkgJson)(e.moduleRootDir,e.root,p)),u.TargetManager.getInstance().isTargetMod()){const t=u.TargetManager.getInstance().getResolveConflictPath(e.moduleRootDir);yield(0,d.savePackageJsonOfResolveConflict)(t,e,p)}yield r.PackageLockerManager.getInstance().flushAllLockers()}finally{v.forEach((e=>(0,i.deleteEmptyOhModulesDir)(e)))}t.PrintUtil.printCostTime(e,"install")}))};