"use strict";var e=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function n(e){try{s(i.next(e))}catch(e){o(e)}}function u(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,u)}s((i=i.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OhpmPublication=void 0;const r=t(require("node-fetch")),i=require("../../registry"),a=require("../../proxy"),o=require("../../handleResponseError"),n=require("../utils/isOverStreamThresholdSize"),u=require("../utils/getPackageUploader"),s=t(require("../../../../log"));exports.OhpmPublication=class{constructor(e){this.authorization=e}publishPackage(t,r,i){return e(this,void 0,void 0,(function*(){const e=Object.assign({},r),a=(0,n.isOverStreamThresholdSize)(t);return(0,u.getPackageUploader)(a).uploadPackage(this.authorization,e,i).then((e=>e)).catch((e=>{if(a&&(404===e.code||this.isRedirectError(e)||405===e.code))return s.default.warn("",`call "/stream/:packageName" api from registry failed cause ${e}, and the "/:packageName" api will be recalled`),this.requestAttachmentUploader(r,i);throw s.default.debug("",`found error while publish: ${e.message}`),e}))}))}unpublishPackage(t,n,u){return e(this,void 0,void 0,(function*(){const e=yield(0,r.default)(u.concat(t),{headers:{command:"unpublish",version:"v1","user-agent":(0,i.getUserAgent)(),Authorization:yield this.authorization.getAuthorization(u),"Content-Type":"application/json; charset=UTF-8"},body:JSON.stringify({version:n}),method:"DELETE",agent:(0,a.getProxyAgent)(u)});return e.ok||(yield(0,o.handleResponseError)(e,"Unpublish")),"ok"}))}requestAttachmentUploader(e,t){return delete e.pkg,(0,u.getPackageUploader)(!1).uploadPackage(this.authorization,e,t)}isRedirectError(e){return 302===e.code||"unsupported-redirect"===e.type}};