"use strict";var e=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(o,a){function c(e){try{s(i.next(e))}catch(e){a(e)}}function n(e){try{s(i.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(c,n)}s((i=i.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DevEcoTraceWriter=void 0;const r=t(require("../../../log")),i=require("../utils/TraceToEventUtils"),o=require("../utils/DevEcoKeyProducerUtils"),a=require("../utils/DateUtils"),c=t(require("path")),n=require("../../../util/FsUtil"),s=require("../TracePathConfig"),u=require("../../../tools/encrypt/factory/EncryptFactory"),l=require("../../../tools/encrypt/EncryptType"),f=require("../utils/BufferUtils"),d=require("../../../util"),T=require("../../../common/message");class E{static getInstance(){return this.INSTANCE||(this.INSTANCE=new E),this.INSTANCE}getTraceFilePath(){const e=s.TracePathConfig.getTraceLogDir(),t=`${s.TracePathConfig.TRACE_FILE_NAME_PREFIX}${s.TracePathConfig.SERVICE_FLAG}_${a.DateUtils.getCurDateToHour()}`;return c.default.join(e,t)}write(t){return e(this,void 0,void 0,(function*(){r.default.debug("","start to write trace data");const e=Date.now(),a=yield o.DevEcoKeyProducerUtils.getKey(),c=yield(0,i.convertTraceToEvent)(t,!1);if(!c)throw f.BufferUtils.freeBuffer(a),new Error(T.Messages.TraceWriter.TraceConvertError);const n=u.EncryptFactory.encrypt(a,JSON.stringify(c.toJSON()),l.EncryptType.AES);if(!n)throw f.BufferUtils.freeBuffer(a),new Error(T.Messages.TraceWriter.TraceEncryptError);f.BufferUtils.freeBuffer(a),yield this.writeToFile(n.concat("\n"));const s=(0,d.calculateCostTime)(e);r.default.debug("",`trace writer complete in ${s}`)}))}writeToFile(t){return e(this,void 0,void 0,(function*(){if(r.default.debug("","start to write trace data to file"),!t)throw new Error(T.Messages.TraceWriter.TraceWriteError);const e=this.getTraceFilePath();yield n.FsUtil.appendFile(e,t),r.default.debug("",`write trace data to file succeed, path: ${e}`)}))}}exports.DevEcoTraceWriter=E;