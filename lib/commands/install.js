"use strict";var e=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,o){function a(e){try{c(n.next(e))}catch(e){o(e)}}function l(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,l)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.installCmd=void 0;const t=require("../core/install"),r=require("../common/GlobalState"),n=require("../core/install/common/OptionValid"),i=require("../config"),o=require("../core/install/common/definitions"),a=require("../core/parameter/util/validParameterFileConfig"),l=require("../core/install/common/checkInvalidCmdWhileParameterization"),c=require("../tools/filelock"),s=require("../core/install/service/getModuleRootDirs"),u=require("../core/scripts/ScriptRunner"),d=require("../core/install-targets/TargetManager");exports.installCmd=function(m,p){return e(this,void 0,void 0,(function*(){r.GlobalState.command=r.CommandType.INSTALL,p.experimentalConcurrentlySafe||(p.experimentalConcurrentlySafe=o.defaultInstallOptions.experimentalConcurrentlySafe),p.experimentalConcurrentlySafe&&r.GlobalState.installMode.push(r.ExperimentalOption.CONCURRENTLY_SAFE_INSTALL);try{yield c.filelock.lock(),(0,n.validInstallOptions)(r.GlobalState.command,p),p.target_path&&(yield d.TargetManager.getInstance().init(p.target_path)),yield(0,a.validParameterFileConfig)(),yield(0,l.checkInvalidCmdWhileParameterization)(m);const e=p.prefix||i.config.getRootDir(),o=(0,s.getModuleRootDirs)(e,p);o.forEach((e=>u.ScriptRunner.runHook(u.ScriptConstants.preInstall,e))),yield(0,t.install)(e,m,p),o.forEach((e=>u.ScriptRunner.runHook(u.ScriptConstants.postInstall,e)))}finally{yield c.filelock.unlock()}}))};