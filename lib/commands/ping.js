"use strict";var e=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{a(r.next(e))}catch(e){o(e)}}function u(e){try{a(r.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}a((r=r.apply(e,t||[])).next())}))},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.pingCmd=void 0;const n=t(require("../log")),r=require("../core/registry"),i=t(require("node-fetch")),o=require("../common/Constants"),s=require("../core/install/common/OptionValid"),u=require("../core/registry"),a=require("../core/registry/OhpmRequestInit"),c=require("../common/message"),f=require("../common/ohpm.config");function d(t,s){return e(this,void 0,void 0,(function*(){s=`${t.trim().replace(/\/?$/g,"")}/${s.trim().replace(/^\//,"")}`;const e=yield(0,u.getAuth)(t),c=(new a.OhpmRequestInit).withAgent((0,r.getProxyAgent)(t)).withTimeout((0,r.getFetchTimeout)()).withRedirect("error");e&&c.withHeaders({Authorization:e});try{const e=yield(0,i.default)(s,c);if(n.default.debug(`STATUS_${e.status}`,`- GET ${s}`),e.ok){const t=yield e.text();return t||!0}return!(404!==e.status||!f.PmConfig.registryWhiteList.includes(t))||(n.default.error("",`HttpCode ${e.status}, API ping in ${t} - ${e.statusText}`),!1)}catch(e){return e.errno=o.Constants.ERR_TYPE_MAP[e.type]?o.Constants.ERR_TYPE_MAP[e.type]:e.errno,o.Constants.ERRNO_EXIT_LIST.includes(e.errno)?(n.default.error(e.errno,e.message),!1):(n.default.error("",e.message),!1)}}))}exports.pingCmd=function(t){return e(this,void 0,void 0,(function*(){const i=Date.now();(0,s.validRequestOptions)("ping",t);const o=yield function(t){return e(this,void 0,void 0,(function*(){const e=[],i=(0,r.getRegistryList)("");if(0===i.length)throw new Error(c.Messages.Ping.RegistryIsEmpty);for(const r of i){n.default.info("PING",r);const i=Date.now(),o=yield d(r,t);if(o){!0!==o&&n.default.info("PONG",o);const e=Date.now()-i;n.default.info("PONG",`${e}ms`)}else e.push(r)}return e}))}("/-/ping"),u=Date.now()-i;if(n.default.info("PONG",`Total ${u}ms`),o.length>0)throw new Error((0,c.format)(c.Messages.Ping.PingRegistriesFailed,{registries:o.join(", ")}))}))};